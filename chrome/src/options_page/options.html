<html>
<head><title>Options</title></head>
<style type="text/css">
.status {
  background: #FFF299;
  padding: 2px 5px;
  border-radius: 3px;
  font-family: Arial, sans-serif;
  font-size: 12px;
  display: none;
  position: absolute;
}
</style>
<script type="text/javascript" src="../scripts_config.js"></script>
<script type="text/javascript">
var credential_options = { username: {label: "Username", type: "text"}, password: { label:"Password", type: "password"} };

function isOptionDef(option) {
  return !!option && !!option.label && !!option.type;
}

function getOptions() {
  var options = eval("("+window.localStorage.getItem("options")+")");
  if(!options) options = {};
  for(var i in SCRIPTS_CONFIG) {
    var script_config = SCRIPTS_CONFIG[i];
    var id = script_config.id;
    if(!options[id]) options[id] = { label: script_config.label, credential: credential_options };
  }
  return options;
}

function listOptions(options, prefixId) {
  var list = [];
  if(isOptionDef(options)) return [!!prefixId?prefixId:""]; 
  for(var id in options) {
    var tmp = listOptions(options[id], (!!prefixId?prefixId+".":"")+id);
    list.push.apply(list, tmp);
  }
  return list;
}

function setStatus(msg) {
  // Update status to let user know options were saved.
  var status = document.getElementById("status");
  status.innerHTML = msg;
  status.style.display = "inline";
  setTimeout(function() {
    status.style.display = "none";
  }, 750);
}

// Saves options to localStorage.
function saveOptions() {
  var options = {};
  var optionElements = document.getElementsByName("option");
  for(var i=0; i<optionElements.length; i++) {
    var inputElement = optionElements[i];
    var id = inputElement.getAttribute("id");
    saveOption(options, id+".type", inputElement.type);
    saveOption(options, id+".value", inputElement.value);
    //options[_options[i].name] = document.getElementById(_options[i].name).value;
  }
  var labels = document.getElementsByName("label");
  for(var i=0; i<labels.length; i++) {
    var id = labels[i].getAttribute("id");
    var label = labels[i].childNodes[0].data;
    saveOption(options, id, label);
  }
//  console.log(options);
  window.localStorage.setItem("options",	JSON.stringify(options));
  setStatus("Options Saved.");
}

function saveOption(options, id, value) {
  var id_parts = id.split(".");
  for(var i in id_parts) {
    id = id_parts[i];
    if(i!=id_parts.length-1) {
      if(!options[id]) options[id] = {};
      options = options[id];
    }
  }
  options[id] = value;
}

// Restores select box state to saved value from localStorage.
function restoreOptions() {
  var options = getOptions();
  for(var id in options) {
    restoreGroup(options, id);
  }
}

function restoreGroup(options, id) {
  var optionsElement = document.getElementById("options");
  var fieldset = document.createElement("fieldset");
  var legend = document.createElement("legend");
  legend.setAttribute("id", id+".label");
  legend.setAttribute("name", "label");
  var text = document.createTextNode(options[id].label);
  legend.appendChild(text);
  fieldset.appendChild(legend);
  var table = document.createElement("table");
  fieldset.appendChild(table);
  optionsElement.appendChild(fieldset);

  restoreOption(options, id+".credential.username", table);
  restoreOption(options, id+".credential.password", table);
}

function restoreOption(options, id, parent) {
  var id_parts = id.split(".");
  var option = options;
  for(var i in id_parts) {
    var part = id_parts[i];
    if(!option[part]) {
      break;
    }
    option = option[part];
  }
  if(!option) {
    console.warn(id + " was not found in " + JSON.stringify(options));
    return;
  }
  var element = createRawOptionElement(id, option);
  parent.appendChild(element);
  var value = option.value;
  if(value == undefined) {
    console.warn(id + " has no value.");
    return;
  }
  document.getElementById(id).value =  value;
}

function createRawOptionElement(id, option) {
  var tr = document.createElement("tr");
  var td1 = document.createElement("td");
  var label = document.createElement("label");
  label.setAttribute("for", id);
  label.setAttribute("name", "label");
  label.setAttribute("id", id+".label");
  var text = document.createTextNode(option.label);
  label.appendChild(text);
  td1.appendChild(label);
  tr.appendChild(td1);
  var td2 = document.createElement("td");
  var input = document.createElement("input");
  input.setAttribute("type", option.type);
  input.setAttribute("id", id);
  input.setAttribute("name", "option");
  if(!!option.value) input.setAttribute("value", option.value);
  td2.appendChild(input);
  tr.appendChild(td2);
  return tr;
}

function captureKey(e) {
  if(e.ctrlKey && e.which==83) { // CTRL + S
    saveOptions();
  }
  return false;
}


window.addEventListener("load", restoreOptions, false);
window.addEventListener("keydown", captureKey, false);

</script>

<body>
<div id="status" class="status"></div>
<div id="options">
</div>
<br>
<button onclick="saveOptions()">Save</button>
</body>
</html>
